<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
<title>Îü≠ÌÇ§ Î∞∞ÌãÄ</title>
<style>
  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: linear-gradient(135deg, #a8d8ff, #ffd4e5);
    min-height: 100vh;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: start;
    color: #222;
    overflow-x: hidden;
  }
  h1 {
    margin: 32px 0 12px 0;
    font-size: 2em;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    animation: fadeIn 1s ease-in;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #game-area {
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 20px rgba(100, 149, 237, 0.2);
    margin: 20px auto;
    border-radius: 20px;
    padding: 25px;
    max-width: 450px;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.3s ease;
  }
  #game-area:hover {
    transform: scale(1.02);
  }
  .status-bar {
    margin: 15px 0 25px 0;
    font-size: 1.1em;
    display: flex;
    gap: 20px;
    justify-content: center;
  }
  .status-bar span {
    padding: 10px 22px;
    border-radius: 12px;
    background: linear-gradient(98deg, #e4eaff88, #b8e0fc44);
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  #stage-indicator {
    font-weight: 700;
    font-size: 1.2em;
    margin-bottom: 10px;
  }
  #monster {
    font-size: 2.5em;
    margin: 10px 0 25px 0;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
  }
  #bosshp, #youratk, #yourhp {
    font-weight: bold;
  }
  #info-msg {
    min-height: 40px;
    font-weight: bold;
    font-size: 1.15em;
    margin-top: 12px;
    color: #6c439b;
    text-align: center;
  }
  #btn-sections {
    width: 100%;
  }
  .btn-section {
    margin-bottom: 20px;
  }
  .stage-label {
    font-size: 1.1em;
    font-weight: 600;
    color: #7c5fe7;
    margin: 8px 0 10px 3px;
    user-select: none;
  }
  .btn-row {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  .up-btn {
    font-size: 1.05em;
    padding: 12px 0;
    border-radius: 14px;
    border: none;
    background: linear-gradient(118deg, #fff7cc 70%, #b8e0fc 100%);
    color: #4e2788;
    font-weight: 700;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
    width: 110px;
    max-width: 32vw;
    user-select: none;
    outline: none;
  }
  .up-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
  }
  .up-btn:active {
    background: #d8fdcc;
    transform: translateY(0);
  }
  .up-btn.win {
    background: #dcffe3;
    color: #228E41;
    animation: btnwin 0.7s;
  }
  .up-btn.lose {
    background: #ffeded;
    color: #cd1c47;
    animation: btnlose 0.7s;
  }
  @keyframes btnwin {
    40% { transform: scale(1.15); }
    70% { transform: scale(0.95); }
    100% { transform: scale(1); }
  }
  @keyframes btnlose {
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
  .odds {
    font-size: 0.9em;
    color: #639ad9;
    font-weight: 600;
    display: block;
    user-select: none;
  }
  .opt-ch {
    font-size: 1em;
    color: #456baa;
    user-select: none;
  }
  #fight-btn,
  #nextstage-btn,
  #restart-btn {
    padding: 14px 40px;
    border-radius: 14px;
    font-size: 1.1em;
    margin: 20px;
    border: none;
    font-weight: 700;
    background: linear-gradient(110deg, #ffe6ec, #b8e0fc);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    color: #41006c;
    cursor: pointer;
    transition: all 0.2s;
    outline: none;
    user-select: none;
  }
  #fight-btn:hover,
  #nextstage-btn:hover,
  #restart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  #fight-btn:active,
  #nextstage-btn:active,
  #restart-btn:active {
    background: #f9fdff;
    color: #4e2788;
    transform: translateY(0);
  }
  .hide {
    display: none !important;
  }
  .result-bar {
    font-weight: 700;
    font-size: 1.2em;
    min-height: 40px;
    margin-top: 12px;
    text-align: center;
    color: #4a1b7b;
  }
  #battle-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  #battle-panel {
    background: #fffbea;
    box-shadow: 0 8px 35px rgba(0, 0, 0, 0.2);
    border-radius: 25px;
    padding: 40px 25px;
    max-width: 400px;
    width: 95vw;
    text-align: center;
    animation: modalin 0.5s ease forwards;
    user-select: none;
  }
  @keyframes modalin {
    0% { transform: scale(0.6); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
  #battle-arena {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  #battle-player, #battle-monster {
    font-size: 3em;
    transition: transform 0.3s ease;
  }
  .battle-stat {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    font-size: 1.15em;
    font-weight: 600;
    margin-bottom: 10px;
  }
  .hpbar {
    height: 18px;
    border-radius: 10px;
    margin: 12px auto;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    width: 90%;
    background: #ddd;
    position: relative;
  }
  .playerbar {
    background: linear-gradient(90deg, #43e5b4, #c2e9fb);
    height: 100%;
    border-radius: 10px;
    width: 100%;
    transition: width 0.7s ease;
  }
  .bossbar {
    background: linear-gradient(90deg, #a29bfe, #fd79a8);
    height: 100%;
    border-radius: 10px;
    width: 100%;
    transition: width 0.7s ease;
  }
  #battle-log {
    min-height: 60px;
    text-align: center;
    font-weight: bold;
    color: #423270de;
    max-height: 120px;
    overflow-y: auto;
    scrollbar-width: thin;
    margin-top: 10px;
  }
  #battle-close {
    margin-top: 15px;
    padding: 10px 25px;
    border-radius: 15px;
    font-weight: 700;
    font-size: 1.05em;
    cursor: pointer;
    background: #48bb78;
    color: white;
    border: none;
    user-select: none;
    outline: none;
    transition: all 0.2s;
  }
  #battle-close:hover {
    background: #43a367;
    transform: translateY(-2px);
  }
  .shake {
    animation: shake 0.5s ease;
  }
  .attack-move {
    animation: attackMove 0.4s ease;
  }
  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    50% { transform: translateX(8px); }
    75% { transform: translateX(-8px); }
    100% { transform: translateX(0); }
  }
  @keyframes attackMove {
    0% { transform: translateX(0); }
    50% { transform: translateX(20px); }
    100% { transform: translateX(0); }
  }
  .float-effect {
    position: absolute;
    font-weight: 700;
    font-size: 1.4em;
    pointer-events: none;
    text-shadow: 0 0 10px #fff;
    animation: floatPop 1s ease forwards;
    white-space: nowrap;
    user-select: none;
    z-index: 502;
    text-align: center;
  }
  .float-attack {
    color: #d8395a;
  }
  .float-heal {
    color: #44a948;
  }
  @keyframes floatPop {
    0% { opacity: 0; transform: translateY(20px); }
    60% { opacity: 1; transform: translateY(-20px); }
    100% { opacity: 0; transform: translateY(-50px); }
  }
</style>
</head>
<body>
  <h1>üé≤ Îü≠ÌÇ§ Î∞∞ÌãÄ üé≤</h1>
  <div id="stage-indicator"></div>
  <div id="game-area">
    <div class="status-bar">
      <span id="youratk">Í≥µÍ≤©Î†•: 8</span>
      <span id="yourhp">Ï≤¥Î†•: 25</span>
    </div>
    <div id="monster"></div>
    <div id="bosshp"></div>
    <div id="info-msg"></div>
    <div id="btn-sections"></div>
    <button id="fight-btn" class="hide">ÎèÑÏ†Ñ! (Î≥¥Ïä§Ï†Ñ)</button>
    <div class="result-bar" id="result"></div>
    <button id="nextstage-btn" class="hide">Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ</button>
    <button id="restart-btn" class="hide">Í≤åÏûÑ Îã§ÏãúÌïòÍ∏∞</button>
  </div>

  <div id="battle-modal">
    <div id="battle-panel">
      <div id="battle-arena">
        <div id="battle-player">üòä</div>
        <div id="battle-monster"></div>
      </div>
      <div class="battle-stat">
        <span id="battle-you"></span>
        <span id="battle-boss"></span>
      </div>
      <div id="battle-hp" class="hpbar playerbar"></div>
      <div id="battle-boss-hp" class="hpbar bossbar"></div>
      <div id="battle-log"></div>
      <button id="battle-close" class="hide">Ï†ÑÌà¨ Ï¢ÖÎ£å</button>
    </div>
  </div>

<script>
const BALANCE = {
  stages: [
    { monster: "üò∫", bossHp: 25, bossAtk: 6, rows: [
      [{ prob: 85, type: 'atk', val: 3 }, { prob: 60, type: 'hp', val: 6 }, { prob: 40, type: 'atk', val: 8 }],
      [{ prob: 75, type: 'atk', val: 4 }, { prob: 65, type: 'hp', val: 5 }, { prob: 45, type: 'atk', val: 7 }],
      [{ prob: 80, type: 'hp', val: 6 }, { prob: 55, type: 'atk', val: 5 }, { prob: 35, type: 'hp', val: 10 }],
      [{ prob: 70, type: 'atk', val: 3 }, { prob: 50, type: 'hp', val: 7 }, { prob: 30, type: 'atk', val: 9 }]
    ]},
    { monster: "ü¶Å", bossHp: 35, bossAtk: 8, rows: [
      [{ prob: 80, type: 'atk', val: 5 }, { prob: 50, type: 'hp', val: 8 }, { prob: 35, type: 'atk', val: 10 }],
      [{ prob: 70, type: 'atk', val: 6 }, { prob: 60, type: 'hp', val: 6 }, { prob: 40, type: 'atk', val: 8 }],
      [{ prob: 75, type: 'hp', val: 7 }, { prob: 50, type: 'atk', val: 7 }, { prob: 30, type: 'hp', val: 12 }],
      [{ prob: 65, type: 'atk', val: 4 }, { prob: 55, type: 'hp', val: 8 }, { prob: 35, type: 'atk', val: 10 }]
    ]},
    { monster: "üê∫", bossHp: 45, bossAtk: 10, rows: [
      [{ prob: 75, type: 'atk', val: 6 }, { prob: 45, type: 'hp', val: 10 }, { prob: 30, type: 'atk', val: 12 }],
      [{ prob: 65, type: 'atk', val: 7 }, { prob: 55, type: 'hp', val: 8 }, { prob: 35, type: 'atk', val: 10 }],
      [{ prob: 70, type: 'hp', val: 8 }, { prob: 50, type: 'atk', val: 8 }, { prob: 30, type: 'hp', val: 14 }],
      [{ prob: 60, type: 'atk', val: 5 }, { prob: 50, type: 'hp', val: 9 }, { prob: 40, type: 'atk', val: 11 }]
    ]},
    { monster: "ü¶ñ", bossHp: 55, bossAtk: 12, rows: [
      [{ prob: 70, type: 'atk', val: 7 }, { prob: 40, type: 'hp', val: 12 }, { prob: 30, type: 'atk', val: 14 }],
      [{ prob: 60, type: 'atk', val: 8 }, { prob: 50, type: 'hp', val: 10 }, { prob: 35, type: 'atk', val: 12 }],
      [{ prob: 65, type: 'hp', val: 9 }, { prob: 45, type: 'atk', val: 9 }, { prob: 30, type: 'hp', val: 15 }],
      [{ prob: 55, type: 'atk', val: 6 }, { prob: 45, type: 'hp', val: 10 }, { prob: 35, type: 'atk', val: 13 }]
    ]},
    { monster: "üêâ", bossHp: 70, bossAtk: 14, rows: [
      [{ prob: 65, type: 'atk', val: 8 }, { prob: 40, type: 'hp', val: 13 }, { prob: 25, type: 'atk', val: 16 }],
      [{ prob: 60, type: 'atk', val: 9 }, { prob: 45, type: 'hp', val: 11 }, { prob: 30, type: 'atk', val: 14 }],
      [{ prob: 60, type: 'hp', val: 10 }, { prob: 40, type: 'atk', val: 10 }, { prob: 25, type: 'hp', val: 16 }],
      [{ prob: 55, type: 'atk', val: 7 }, { prob: 40, type: 'hp', val: 11 }, { prob: 30, type: 'atk', val: 15 }]
    ]},
    { monster: "üëπ", bossHp: 85, bossAtk: 16, rows: [
      [{ prob: 60, type: 'atk', val: 9 }, { prob: 35, type: 'hp', val: 14 }, { prob: 25, type: 'atk', val: 18 }],
      [{ prob: 55, type: 'atk', val: 10 }, { prob: 40, type: 'hp', val: 12 }, { prob: 30, type: 'atk', val: 16 }],
      [{ prob: 60, type: 'hp', val: 11 }, { prob: 35, type: 'atk', val: 11 }, { prob: 25, type: 'hp', val: 18 }],
      [{ prob: 50, type: 'atk', val: 8 }, { prob: 35, type: 'hp', val: 12 }, { prob: 30, type: 'atk', val: 17 }]
    ]},
    { monster: "üßô‚Äç‚ôÇÔ∏è", bossHp: 100, bossAtk: 18, rows: [
      [{ prob: 55, type: 'atk', val: 10 }, { prob: 35, type: 'hp', val: 15 }, { prob: 20, type: 'atk', val: 20 }],
      [{ prob: 50, type: 'atk', val: 11 }, { prob: 40, type: 'hp', val: 13 }, { prob: 25, type: 'atk', val: 18 }],
      [{ prob: 55, type: 'hp', val: 12 }, { prob: 35, type: 'atk', val: 12 }, { prob: 20, type: 'hp', val: 20 }],
      [{ prob: 50, type: 'atk', val: 9 }, { prob: 35, type: 'hp', val: 13 }, { prob: 25, type: 'atk', val: 19 }]
    ]},
    { monster: "ü¶á", bossHp: 120, bossAtk: 20, rows: [
      [{ prob: 50, type: 'atk', val: 11 }, { prob: 30, type: 'hp', val: 16 }, { prob: 20, type: 'atk', val: 22 }],
      [{ prob: 45, type: 'atk', val: 12 }, { prob: 35, type: 'hp', val: 14 }, { prob: 25, type: 'atk', val: 20 }],
      [{ prob: 50, type: 'hp', val: 13 }, { prob: 30, type: 'atk', val: 13 }, { prob: 20, type: 'hp', val: 22 }],
      [{ prob: 45, type: 'atk', val: 10 }, { prob: 30, type: 'hp', val: 14 }, { prob: 25, type: 'atk', val: 21 }]
    ]},
    { monster: "üï∏Ô∏è", bossHp: 140, bossAtk: 22, rows: [
      [{ prob: 45, type: 'atk', val: 12 }, { prob: 30, type: 'hp', val: 17 }, { prob: 20, type: 'atk', val: 24 }],
      [{ prob: 40, type: 'atk', val: 13 }, { prob: 35, type: 'hp', val: 15 }, { prob: 20, type: 'atk', val: 22 }],
      [{ prob: 45, type: 'hp', val: 14 }, { prob: 30, type: 'atk', val: 14 }, { prob: 20, type: 'hp', val: 24 }],
      [{ prob: 40, type: 'atk', val: 11 }, { prob: 30, type: 'hp', val: 15 }, { prob: 20, type: 'atk', val: 23 }]
    ]},
    { monster: "üëª", bossHp: 160, bossAtk: 24, rows: [
      [{ prob: 40, type: 'atk', val: 13 }, { prob: 25, type: 'hp', val: 18 }, { prob: 15, type: 'atk', val: 26 }],
      [{ prob: 35, type: 'atk', val: 14 }, { prob: 30, type: 'hp', val: 16 }, { prob: 20, type: 'atk', val: 24 }],
      [{ prob: 40, type: 'hp', val: 15 }, { prob: 25, type: 'atk', val: 15 }, { prob: 15, type: 'hp', val: 26 }],
      [{ prob: 35, type: 'atk', val: 12 }, { prob: 25, type: 'hp', val: 16 }, { prob: 20, type: 'atk', val: 25 }]
    ]},
    { monster: "üßù‚Äç‚ôÄÔ∏è", bossHp: 180, bossAtk: 26, rows: [
      [{ prob: 35, type: 'atk', val: 14 }, { prob: 25, type: 'hp', val: 19 }, { prob: 15, type: 'atk', val: 28 }],
      [{ prob: 30, type: 'atk', val: 15 }, { prob: 25, type: 'hp', val: 17 }, { prob: 15, type: 'atk', val: 26 }],
      [{ prob: 35, type: 'hp', val: 16 }, { prob: 20, type: 'atk', val: 16 }, { prob: 15, type: 'hp', val: 28 }],
      [{ prob: 30, type: 'atk', val: 13 }, { prob: 20, type: 'hp', val: 17 }, { prob: 15, type: 'atk', val: 27 }]
    ]},
    { monster: "üòà", bossHp: 200, bossAtk: 28, rows: [
      [{ prob: 30, type: 'atk', val: 15 }, { prob: 20, type: 'hp', val: 20 }, { prob: 10, type: 'atk', val: 30 }],
      [{ prob: 25, type: 'atk', val: 16 }, { prob: 20, type: 'hp', val: 18 }, { prob: 15, type: 'atk', val: 28 }],
      [{ prob: 30, type: 'hp', val: 17 }, { prob: 20, type: 'atk', val: 17 }, { prob: 10, type: 'hp', val: 30 }],
      [{ prob: 25, type: 'atk', val: 14 }, { prob: 20, type: 'hp', val: 18 }, { prob: 15, type: 'atk', val: 29 }]
    ]}
  ],
  startAtk: 8,
  startHp: 25
};

let nowStage = 0, yourAtk = BALANCE.startAtk, yourHp = BALANCE.startHp, bossHp = 0, bossAtk = 0;

const stageDiv = document.getElementById("stage-indicator");
const yourAtkSpan = document.getElementById("youratk");
const yourHpSpan = document.getElementById("yourhp");
const monsterDiv = document.getElementById("monster");
const bossHpDiv = document.getElementById("bosshp");
const btnSections = document.getElementById("btn-sections");
const fightBtn = document.getElementById("fight-btn");
const infoMsg = document.getElementById("info-msg");
const nextBtn = document.getElementById("nextstage-btn");
const restartBtn = document.getElementById("restart-btn");
const resultDiv = document.getElementById("result");

const battleModal = document.getElementById("battle-modal");
const battlePanel = document.getElementById("battle-panel");
const battlePlayer = document.getElementById("battle-player");
const battleMonster = document.getElementById("battle-monster");
const battleYou = document.getElementById("battle-you");
const battleBoss = document.getElementById("battle-boss");
const battleLog = document.getElementById("battle-log");
const battleClose = document.getElementById("battle-close");
const battleHP = document.getElementById("battle-hp");
const battleBossHP = document.getElementById("battle-boss-hp");

function play(key) {
  const files = {
    win: 'https://actions.google.com/sounds/v1/cartoon/chime_up.ogg',
    lose: 'https://actions.google.com/sounds/v1/cartoon/negative_beeps.ogg',
    select: 'https://actions.google.com/sounds/v1/ui/click_soft.ogg',
    fight: 'https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg',
    victory: 'https://actions.google.com/sounds/v1/cartoon/concussive_drum_hit.ogg',
    defeat: 'https://actions.google.com/sounds/v1/cartoon/drop_warning.ogg',
    attack: 'https://actions.google.com/sounds/v1/impacts/punch_to_body_1.ogg'
  };
  if (files[key]) {
    let audio = new Audio(files[key]);
    audio.volume = 0.45;
    audio.play().catch(() => {});
  }
}

function startGame() {
  nowStage = 0;
  yourAtk = BALANCE.startAtk;
  yourHp = BALANCE.startHp;
  resultDiv.textContent = "";
  nextBtn.classList.add("hide");
  restartBtn.classList.add("hide");
  fightBtn.classList.add("hide");
  battleModal.style.display = "none";
  loadStage();
}

function loadStage() {
  const st = BALANCE.stages[nowStage];
  stageDiv.textContent = `Ïä§ÌÖåÏù¥ÏßÄ ${nowStage + 1} / ${BALANCE.stages.length}`;
  monsterDiv.textContent = st.monster;
  bossHpDiv.textContent = `Î≥¥Ïä§ Ï≤¥Î†•: ${st.bossHp}`;
  bossHp = st.bossHp; bossAtk = st.bossAtk || 10;
  yourAtkSpan.textContent = `Í≥µÍ≤©Î†•: ${yourAtk}`;
  yourHpSpan.textContent = `Ï≤¥Î†•: ${yourHp}`;
  resultDiv.textContent = "";
  infoMsg.textContent = `Í∞Å ÌñâÎßàÎã§ ÌïòÎÇòÏî© ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!`;
  fightBtn.classList.add("hide");
  nextBtn.classList.add("hide");
  restartBtn.classList.add("hide");
  btnSections.innerHTML = "";
  let selectedRows = 0;
  st.rows.forEach((row, rowIdx) => {
    let section = document.createElement('div');
    section.className = 'btn-section';
    section.innerHTML = `<div class="stage-label">ÏòµÏÖò ÏÑ†ÌÉù ${rowIdx + 1}</div>`;
    let rowDiv = document.createElement('div');
    rowDiv.className = 'btn-row';
    let rowSelected = false;
    row.forEach((btnOpt, colIdx) => {
      let btn = document.createElement('button');
      btn.className = 'up-btn';
      btn.innerHTML = `<span class="odds">ÌôïÎ•† ${btnOpt.prob}%</span><span class="opt-ch">${btnOpt.type === 'atk' ? 'Í≥µÍ≤©Î†•' : 'Ï≤¥Î†•'} +${btnOpt.val}</span>`;
      btn.onclick = () => {
        if (rowSelected) return;
        play('select');
        rowSelected = true;
        rowDiv.querySelectorAll('button').forEach(b => b.disabled = true);
        let rand = Math.random() * 100;
        if (rand < btnOpt.prob) {
          btn.classList.add('win');
          play('win');
          if (btnOpt.type === 'atk') {
            yourAtk += btnOpt.val;
            yourAtkSpan.textContent = `Í≥µÍ≤©Î†•: ${yourAtk}`;
          } else {
            yourHp += btnOpt.val;
            yourHpSpan.textContent = `Ï≤¥Î†•: ${yourHp}`;
          }
          infoMsg.textContent = `ÏÑ±Í≥µ! ${btnOpt.type === 'atk' ? "Í≥µÍ≤©Î†•" : "Ï≤¥Î†•"} +${btnOpt.val}`;
        } else {
          btn.classList.add('lose');
          play('lose');
          infoMsg.textContent = `Ïã§Ìå®! ÏïÑÎ¨¥ Ìö®Í≥º ÏóÜÏùå`;
        }
        selectedRows++;
        if (selectedRows === st.rows.length) {
          Array.from(btnSections.querySelectorAll('button')).forEach(b => b.disabled = true);
          fightBtn.classList.remove("hide");
          infoMsg.textContent = `Î™®Îì† ÏÑ†ÌÉù ÏôÑÎ£å! ÎèÑÏ†Ñ Î≤ÑÌäºÏúºÎ°ú Î≥¥Ïä§ÏôÄ Ïã∏Ïö∞ÏÑ∏Ïöî!`;
        }
      };
      rowDiv.appendChild(btn);
    });
    section.appendChild(rowDiv);
    btnSections.appendChild(section);
  });
}

fightBtn.onclick = () => {
  play('fight');
  battleModal.style.display = "flex";
  battleMonster.textContent = BALANCE.stages[nowStage].monster;
  battleYou.textContent = `ÎÇ¥ Ï≤¥Î†•: ${yourHp}`;
  battleBoss.textContent = `Î≥¥Ïä§ Ï≤¥Î†•: ${bossHp}`;
  battleHP.style.width = "100%";
  battleBossHP.style.width = "100%";
  battleLog.innerHTML = "<b>Ï†ÑÌà¨ ÏãúÏûë!</b>";
  battleClose.classList.add("hide");

  let playerHP = yourHp, bossCurrentHP = bossHp;
  let maxTurns = 10, turn = 0;

  function battleRound() {
    if (turn >= maxTurns || playerHP <= 0 || bossCurrentHP <= 0) {
      setTimeout(() => {
        if (bossCurrentHP <= 0) {
          battleLog.innerHTML += "<br><span class='battle-dmg'>Î≥¥Ïä§Î•º Ï≤òÏπòÌñàÏäµÎãàÎã§!</span>";
          play('victory');
          endBattle(true);
        } else if (playerHP <= 0) {
          battleLog.innerHTML += "<br><span class='battle-dmg'>Ìå®Î∞∞! Ï≤¥Î†•Ïù¥ Î™®Îëê ÏÜåÏßÑÎêòÏóàÏäµÎãàÎã§.</span>";
          play('defeat');
          endBattle(false);
        } else {
          battleLog.innerHTML += "<br><span style='color:#e6c222;'>Î¨¥ÏäπÎ∂Ä! (ÌÑ¥Ïàò Ï¥àÍ≥º)</span>";
          play('lose');
          endBattle(false);
        }
      }, 1000);
      return;
    }
    turn++;
    // ÌîåÎ†àÏù¥Ïñ¥ Í≥µÍ≤©
    let playerDmg = Math.max(5, Math.floor(yourAtk * (0.6 + Math.random() * 0.5)));
    bossCurrentHP = Math.max(0, bossCurrentHP - playerDmg);
    battleBossHP.style.width = (bossCurrentHP / bossHp * 100).toFixed(1) + "%";
    battleBoss.textContent = `Î≥¥Ïä§ Ï≤¥Î†•: ${bossCurrentHP}`;
    battlePlayer.classList.add("attack-move");
    battleMonster.classList.add("shake");
    play('attack');
    animateFloatDamage(battleMonster, playerDmg, false);
    setTimeout(() => {
      battlePlayer.classList.remove("attack-move");
      battleMonster.classList.remove("shake");
    }, 400);
    battleLog.innerHTML += `<br><span class="battle-hit">ÌÑ¥${turn}: ÎÇ¥Í∞Ä Í≥µÍ≤©! Îç∞ÎØ∏ÏßÄ <b>${playerDmg}</b></span>`;
    // Î≥¥Ïä§ Î∞òÍ≤©
    setTimeout(() => {
      if (bossCurrentHP === 0) return battleRound();
      let bossDmg = Math.max(6, Math.floor(bossAtk * (0.65 + Math.random() * 0.5)));
      playerHP = Math.max(0, playerHP - bossDmg);
      battleHP.style.width = (playerHP / yourHp * 100).toFixed(1) + "%";
      battleYou.textContent = `ÎÇ¥ Ï≤¥Î†•: ${playerHP}`;
      battleMonster.classList.add("attack-move");
      battlePlayer.classList.add("shake");
      play('attack');
      animateFloatDamage(battlePlayer, bossDmg, true);
      setTimeout(() => {
        battleMonster.classList.remove("attack-move");
        battlePlayer.classList.remove("shake");
      }, 400);
      battleLog.innerHTML += `<br><span class="battle-dmg">Î≥¥Ïä§ Î∞òÍ≤©! Îç∞ÎØ∏ÏßÄ <b>${bossDmg}</b></span>`;
      setTimeout(battleRound, 1200);
    }, 1000);
  }
  setTimeout(battleRound, 100);
}

function animateFloatDamage(parentElem, dmg, isHeal) {
  const fx = document.createElement("span");
  fx.textContent = (isHeal ? "-" : "-") + dmg;
  fx.className = "float-effect " + (isHeal ? "float-attack" : "float-attack");
  fx.style.left = isHeal ? "75%" : "25%"; // Position damage near respective character
  parentElem.parentNode.appendChild(fx);
  setTimeout(() => fx.remove(), 1000);
}

function endBattle(win) {
  battleClose.classList.remove("hide");
  resultDiv.textContent = win ? "ÏäπÎ¶¨! Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§." : "Ìå®Î∞∞! Ï≤¥Î†•ÏùÑ ÌöåÎ≥µÌïòÍ±∞ÎÇò Îã§Ïãú ÎèÑÏ†ÑÌïòÏÑ∏Ïöî.";
  fightBtn.classList.add("hide");
  nextBtn.classList.toggle("hide", !win || nowStage === BALANCE.stages.length - 1);
  restartBtn.classList.toggle("hide", (win && nowStage === BALANCE.stages.length - 1) || !win);
  infoMsg.textContent = win ? "Ï∂ïÌïòÌï©ÎãàÎã§! Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄ ÎèÑÏ†Ñ!" : "Ï≤¥Î†•ÏùÑ ÌöåÎ≥µÌïòÍ±∞ÎÇò Îã§Ïãú ÎèÑÏ†ÑÌïòÏÑ∏Ïöî!";
  battleLog.scrollTop = battleLog.scrollHeight;
}

battleClose.onclick = () => {
  battleModal.style.display = "none";
};

nextBtn.onclick = () => {
  nowStage++;
  loadStage();
  nextBtn.classList.add("hide");
  fightBtn.classList.add("hide");
  restartBtn.classList.add("hide");
  resultDiv.textContent = "";
  infoMsg.textContent = `ÏÉàÎ°úÏö¥ Ïä§ÌÖåÏù¥ÏßÄÏóê ÎèÑÏ†ÑÌïòÏÑ∏Ïöî!`;
};

restartBtn.onclick = startGame;

window.onload = startGame;
</script>
</body>
</html>